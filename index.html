<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Account Strategy Intelligence (ASI)</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* ===== CSS Styles (เหมือนเดิม) ===== */
    :root {
      --primary: #60A5FA;
      --primary-dark: #3B82F6;
      --secondary: #5856D6;
      --green: #34C759;
      --orange: #FF9500;
      --red: #FF3B30;
      --gray-1: #8E8E93;
      --gray-2: #AEAEB2;
      --gray-3: #C7C7CC;
      --gray-4: #D1D1D6;
      --gray-5: #E5E5EA;
      --gray-6: #F2F2F7;
      --background: #FFFFFF;
      --card-background: #FFFFFF;
      --text-primary: #000000;
      --text-secondary: #8E8E93;
      --system-blur: rgba(255, 255, 255, 0.8);
      --system-border: rgba(0, 0, 0, 0.1);
      --light-blue-bg: rgba(96, 165, 250, 0.05);
      --light-gray-bg: rgba(142, 142, 147, 0.05);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --background: #000000;
        --card-background: #1C1C1E;
        --text-primary: #FFFFFF;
        --text-secondary: #8E8E93;
        --system-blur: rgba(30, 30, 32, 0.8);
        --system-border: rgba(255, 255, 255, 0.1);
        --light-blue-bg: rgba(96, 165, 250, 0.1);
        --light-gray-bg: rgba(142, 142, 147, 0.1);
      }
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      background: var(--background);
      color: var(--text-primary);
      line-height: 1.47;
      -webkit-font-smoothing: antialiased;
      min-height: 100vh;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
    }

    /* Loading Screen */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--background);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .loading-logo {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 24px;
      animation: logoPulse 2s ease-in-out infinite;
    }

    .loading-text {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .loading-subtext {
      font-size: 17px;
      color: var(--text-secondary);
      margin-bottom: 32px;
    }

    .ios-progress {
      width: 200px;
      height: 4px;
      background: var(--gray-5);
      border-radius: 2px;
      overflow: hidden;
    }

    .ios-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      width: 0%;
      transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 2px;
    }

    /* Main App Container */
    .app-container {
      min-height: 100vh;
      display: none;
      flex-direction: column;
      background: var(--background);
    }

    /* iOS Style Navigation Bar */
    .ios-navbar {
      background: var(--system-blur);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--system-border);
      padding: 12px 16px;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .nav-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
    }

    .nav-brand {
      font-size: 21px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-brand-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .nav-brand-icon i {
      font-size: 16px;
      color: white;
    }

    .nav-actions {
      display: flex;
      gap: 8px;
    }

    /* iOS Style Buttons */
    .ios-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      text-decoration: none;
    }

    .ios-btn-primary {
      background: var(--primary);
      color: white;
    }

    .ios-btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .ios-btn-secondary {
      background: var(--gray-6);
      color: var(--text-primary);
    }

    .ios-btn-secondary:hover {
      background: var(--gray-5);
    }

    /* Content Area */
    .content-area {
      flex: 1;
      padding: 16px;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }

    /* iOS Style Cards */
    .ios-card {
      background: var(--card-background);
      border-radius: 12px;
      padding: 0;
      margin-bottom: 16px;
      border: 1px solid var(--system-border);
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .ios-card-header {
      padding: 16px;
      border-bottom: 1px solid var(--system-border);
      background: var(--light-blue-bg);
    }

    .ios-card-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .ios-card-subtitle {
      font-size: 15px;
      color: var(--text-secondary);
    }

    .ios-card-body {
      padding: 16px;
    }

    /* Form Elements */
    .form-section {
      margin-bottom: 24px;
      background: var(--light-gray-bg);
      border-radius: 10px;
      padding: 16px;
      border: 1px solid var(--system-border);
    }

    .section-header {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 12px;
      padding: 12px 16px;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--light-blue-bg);
      border-radius: 8px;
      margin: -12px -12px 16px -12px;
    }

    .ios-input-group {
      margin-bottom: 16px;
    }

    .ios-label {
      display: block;
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text-primary);
      padding: 0 16px;
    }

    .ios-label.required::after {
      content: " *";
      color: var(--red);
    }

    .ios-input {
      width: 100%;
      padding: 12px 16px;
      background: var(--card-background);
      border: 1px solid var(--system-border);
      border-radius: 10px;
      font-size: 16px;
      color: var(--text-primary);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .ios-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2);
    }

    .ios-select {
      width: 100%;
      padding: 12px 16px;
      background: var(--card-background);
      border: 1px solid var(--system-border);
      border-radius: 10px;
      font-size: 16px;
      color: var(--text-primary);
      appearance: none;
      background-image: url("data:image/svg+xml;charset=US-ASCII,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 4 5'><path fill='%238E8E93' d='M2 0L0 2h4zm0 5L0 3h4z'/></svg>");
      background-repeat: no-repeat;
      background-position: right 16px center;
      background-size: 10px;
    }

    /* Checkbox Styles */
    .unknown-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
      padding: 0 16px;
    }

    .unknown-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      border-radius: 4px;
      border: 2px solid var(--gray-3);
      background: var(--card-background);
    }

    .unknown-checkbox label {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* Customer ID Display */
    .customer-id-display {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 12px 16px;
      border-radius: 10px;
      margin-bottom: 16px;
      font-weight: 600;
      font-size: 16px;
      display: none;
    }

    /* iOS Style Analysis Results */
    .analysis-section {
      margin-top: 24px;
    }

    .recommendation-grid {
      display: grid;
      gap: 12px;
      margin-top: 16px;
    }

    .recommendation-card {
      background: var(--card-background);
      border: 1px solid var(--system-border);
      border-radius: 12px;
      padding: 16px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .recommendation-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .recommendation-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .recommendation-title {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .recommendation-badge {
      background: var(--primary);
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
    }

    .recommendation-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }

    .detail-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .detail-label {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .detail-value {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .recommendation-reason {
      font-size: 15px;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    /* iOS Style Tabs */
    .ios-tabs {
      display: flex;
      background: var(--card-background);
      border-radius: 10px;
      padding: 4px;
      margin-bottom: 20px;
      border: 1px solid var(--system-border);
    }

    .ios-tab {
      flex: 1;
      padding: 8px 12px;
      text-align: center;
      font-size: 15px;
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .ios-tab.active {
      background: var(--primary);
      color: white;
    }

    /* Form Status */
    .form-status {
      padding: 12px 16px;
      background: var(--green);
      color: white;
      border-radius: 10px;
      margin-top: 16px;
      font-size: 14px;
      display: none;
    }

    /* Content Panels */
    .content-panel {
      display: none;
    }

    .content-panel.active {
      display: block;
    }

    /* Animations */
    @keyframes logoPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
      animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .content-area {
        padding: 12px;
      }
      
      .nav-content {
        flex-direction: column;
        gap: 12px;
      }
      
      .recommendation-details {
        grid-template-columns: 1fr;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Form Grid */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    /* CSS สำหรับ urgency levels */
    .urgency-critical {
      border-left: 4px solid #FF3B30;
      background: linear-gradient(135deg, rgba(255, 59, 48, 0.05), rgba(255, 149, 0, 0.05));
    }

    .urgency-high {
      border-left: 4px solid #FF9500;
      background: linear-gradient(135deg, rgba(255, 149, 0, 0.05), rgba(255, 204, 0, 0.05));
    }

    .urgency-medium {
      border-left: 4px solid #34C759;
      background: linear-gradient(135deg, rgba(52, 199, 89, 0.05), rgba(88, 86, 214, 0.05));
    }

    .urgency-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-top: 4px;
      display: inline-block;
    }

    .urgency-badge.critical {
      background: #FF3B30;
      color: white;
    }

    .urgency-badge.high {
      background: #FF9500;
      color: white;
    }

    .urgency-badge.medium {
      background: #34C759;
      color: white;
    }

    .detail-section {
      margin-bottom: 12px;
    }

    .detail-section .detail-label {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
      font-size: 14px;
    }

    .detail-section .detail-value {
      color: var(--text-secondary);
      font-size: 14px;
      line-height: 1.4;
    }

    .product-tag {
      display: inline-block;
      background: var(--primary);
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      margin: 2px 4px 2px 0;
      font-size: 12px;
    }

    .customer-id-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .popup-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
    }

    .popup-content {
      position: relative;
      background: var(--card-background);
      border-radius: 16px;
      padding: 0;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      border: 1px solid var(--system-border);
    }

    .popup-header {
      padding: 20px 20px 0;
      text-align: center;
    }

    .popup-body {
      padding: 20px;
      text-align: center;
    }

    .customer-id-large {
      font-size: 32px;
      font-weight: 700;
      color: var(--primary);
      margin: 16px 0;
      padding: 16px;
      background: var(--light-blue-bg);
      border-radius: 12px;
      border: 2px dashed var(--primary);
    }

    .popup-footer {
      padding: 0 20px 20px;
      text-align: center;
    }

    /* Search and Filter Styles */
    .search-filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .customer-list {
      max-height: 500px;
      overflow-y: auto;
    }

    .customer-item {
      padding: 12px 16px;
      border-bottom: 1px solid var(--system-border);
      cursor: pointer;
      transition: background 0.2s;
    }

    .customer-item:hover {
      background: var(--light-gray-bg);
    }

    .customer-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .customer-name {
      font-weight: 600;
      font-size: 16px;
    }

    .customer-id {
      color: var(--primary);
      font-size: 14px;
    }

    /* Search placeholder */
    .search-placeholder {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }

    /* Dashboard Styles */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--card-background);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid var(--system-border);
      text-align: center;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* Chart Containers */
    .chart-container {
      position: relative;
      height: 200px;
      margin: 16px 0;
    }

    /* Export Options */
    .export-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    /* Data Management */
    .data-management {
      margin-top: 24px;
    }

    .delete-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    .delete-warning {
      background: rgba(255, 59, 48, 0.1);
      border: 1px solid var(--red);
      border-radius: 8px;
      padding: 12px;
      margin-top: 16px;
      font-size: 14px;
    }

    .spinner-border {
      width: 2rem;
      height: 2rem;
      border: 0.25em solid currentColor;
      border-right-color: transparent;
      border-radius: 50%;
      animation: spinner-border .75s linear infinite;
    }

    @keyframes spinner-border {
      to { transform: rotate(360deg); }
    }

    /* No Insurance Button */
    .no-insurance-btn {
      margin-top: 12px;
      width: 100%;
    }

    .search-placeholder {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }

    /* NEW STYLES FOR ENHANCED SEARCH */
    .customer-list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid var(--system-border);
      transition: background 0.2s;
    }

    .customer-list-item:hover {
      background: var(--light-gray-bg);
    }

    .customer-info {
      flex: 1;
    }

    .customer-main-info {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 4px;
    }

    .customer-secondary-info {
      display: flex;
      gap: 16px;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .select-btn {
      padding: 8px 16px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
    }

    .select-btn:hover {
      background: var(--primary-dark);
    }

    /* Customer Detail Modal Styles */
    .customer-detail-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
    }

    .modal-content {
      position: relative;
      background: var(--card-background);
      border-radius: 16px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      border: 1px solid var(--system-border);
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--system-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--light-blue-bg);
      border-radius: 16px 16px 0 0;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 20px;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: background 0.2s;
    }

    .close-btn:hover {
      background: var(--gray-5);
    }

    .modal-body {
      padding: 24px;
      flex: 1;
      overflow-y: auto;
    }

    /* Customer Detail Grid */
    .customer-detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .detail-section {
      background: var(--light-gray-bg);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid var(--system-border);
    }

    .detail-section-title {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--primary);
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--system-border);
    }

    .detail-row:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .detail-label {
      font-weight: 600;
      color: var(--text-primary);
      min-width: 120px;
    }

    .detail-value {
      color: var(--text-secondary);
      text-align: right;
      flex: 1;
    }

    .editable-field {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
    }

    .editable-field input,
    .editable-field select {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid var(--system-border);
      border-radius: 8px;
      background: var(--card-background);
      color: var(--text-primary);
      min-width: 0;
    }

    .edit-btn {
      background: none;
      border: none;
      color: var(--primary);
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background 0.2s;
      min-width: 32px;
    }

    .edit-btn:hover {
      background: var(--light-blue-bg);
    }

    /* Comments Section */
    .comments-section {
      margin-top: 24px;
    }

    .comments-list {
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 16px;
    }

    .comment-item {
      padding: 12px;
      background: var(--card-background);
      border-radius: 8px;
      margin-bottom: 8px;
      border: 1px solid var(--system-border);
    }

    .comment-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .comment-author {
      font-weight: 600;
      color: var(--primary);
    }

    .comment-date {
      color: var(--text-secondary);
      font-size: 12px;
    }

    .comment-text {
      color: var(--text-primary);
      line-height: 1.4;
    }

    .comment-form {
      display: flex;
      gap: 12px;
    }

    .comment-input {
      flex: 1;
      padding: 12px;
      border: 1px solid var(--system-border);
      border-radius: 8px;
      background: var(--card-background);
      color: var(--text-primary);
    }

    /* Action Buttons */
    .action-buttons {
      display: flex;
      gap: 12px;
      margin-top: 24px;
      padding-top: 16px;
      border-top: 1px solid var(--system-border);
    }

    .save-btn {
      flex: 1;
    }

    .cancel-btn {
      flex: 1;
    }

    /* Update History */
    .update-history {
      margin-top: 20px;
      padding: 16px;
      background: var(--light-gray-bg);
      border-radius: 8px;
      border: 1px solid var(--system-border);
    }

    .update-history-title {
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .update-item {
      padding: 8px 0;
      border-bottom: 1px solid var(--system-border);
    }

    .update-item:last-child {
      border-bottom: none;
    }

    .update-details {
      font-size: 14px;
      color: var(--text-secondary);
    }

    /* Security Modal */
    .security-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .security-content {
      background: var(--card-background);
      border-radius: 12px;
      padding: 20px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    /* Loading Spinner */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--gray-4);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Alert Messages */
    .alert-success {
      background: var(--green);
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .alert-error {
      background: var(--red);
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    /* Policy Items */
    .policy-item {
      background: var(--card-background);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid var(--system-border);
    }

    .btn-remove-policy {
      margin-top: 12px;
    }

    /* Policy Form */
    .policy-form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-logo">
      <i class="fas fa-brain"></i>
    </div>
    <h1 class="loading-text">Account Strategy Intelligence</h1>
    <p class="loading-subtext">Advanced Customer Analytics System</p>
    <div class="ios-progress">
      <div class="ios-progress-bar" id="loadingProgress"></div>
    </div>
  </div>

  <!-- Main Application -->
  <div class="app-container" id="appContainer">
    <!-- iOS Style Navigation Bar -->
    <nav class="ios-navbar">
      <div class="nav-content">
        <div class="nav-brand">
          <div class="nav-brand-icon">
            <i class="fas fa-brain"></i>
          </div>
          <span>Account Strategy Intelligence (ASI)</span>
        </div>
        <div class="nav-actions">
          <button class="ios-btn ios-btn-secondary" id="btnLogout">
            <i class="fas fa-door-open"></i>
            Sign Out
          </button>
        </div>
      </div>
    </nav>

    <!-- Content Area -->
    <div class="content-area">
      <!-- iOS Style Tabs -->
      <div class="ios-tabs">
        <div class="ios-tab active" data-panel="start">
          <i class="fas fa-house"></i>
          หน้าแรก
        </div>
        <div class="ios-tab" data-panel="form">
          <i class="fas fa-user-plus"></i>
          สร้างลูกค้า
        </div>
        <div class="ios-tab" data-panel="search">
          <i class="fas fa-search"></i>
          ค้นหาข้อมูล
        </div>
        <div class="ios-tab" data-panel="report">
          <i class="fas fa-chart-bar"></i>
          รายงาน
        </div>
      </div>

      <!-- Start Panel -->
      <div id="panel-start" class="content-panel active fade-in">
        <div class="ios-card">
          <div class="ios-card-header">
            <h2 class="ios-card-title">
              <i class="fas fa-rocket" style="color: var(--primary);"></i>
              ยินดีต้อนรับสู่ ASI
            </h2>
            <p class="ios-card-subtitle">ระบบวิเคราะห์และวางแผนกลยุทธ์ลูกค้าแบบบูรณาการ</p>
          </div>
          <div class="ios-card-body">
            <div style="text-align: center; padding: 40px 20px;">
              <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 20px; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 24px;">
                <i class="fas fa-chart-network" style="font-size: 32px; color: white;"></i>
              </div>
              <h3 style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">เริ่มต้นใช้งานระบบ</h3>
              <p style="color: var(--text-secondary); margin-bottom: 32px;">ระบบ AI ขั้นสูงจะช่วยวิเคราะห์และแนะนำผลิตภัณฑ์ที่เหมาะสมที่สุดตามโปรไฟล์ลูกค้า</p>
              <button class="ios-btn ios-btn-primary" id="btnStart" style="padding: 12px 32px; font-size: 17px;">
                <i class="fas fa-play"></i>
                เริ่มต้นใช้งาน
              </button>
            </div>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="dashboard-grid">
          <div class="stat-card">
            <div class="stat-value" id="totalCustomers">0</div>
            <div class="stat-label">ลูกค้าทั้งหมด</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalAnalysis">0</div>
            <div class="stat-label">การวิเคราะห์</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="successRate">0%</div>
            <div class="stat-label">อัตราความสำเร็จ</div>
          </div>
        </div>
      </div>

      <!-- Form Panel -->
      <div id="panel-form" class="content-panel">
        <div class="ios-card">
          <div class="ios-card-header">
            <h2 class="ios-card-title">
              <i class="fas fa-user-plus" style="color: var(--primary);"></i>
              สร้างโปรไฟล์ลูกค้า
            </h2>
            <p class="ios-card-subtitle">กรอกข้อมูลลูกค้าเพื่อรับการวิเคราะห์จาก AI</p>
          </div>
          <div class="ios-card-body">
            <!-- Customer ID Display -->
            <div class="customer-id-display" id="customerIdDisplay">
              <i class="fas fa-id-card"></i>
              Customer ID: กำลังสร้าง...
            </div>

            <!-- Employee Information -->
            <div class="form-section">
              <h3 class="section-header">
                <i class="fas fa-user-tie"></i>
                ข้อมูลพนักงาน
              </h3>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label required">ชื่อพนักงาน</label>
                  <input type="text" class="ios-input" id="employee_name" placeholder="กรอกชื่อพนักงาน">
                </div>
                <div class="ios-input-group">
                  <label class="ios-label required">รหัสพนักงาน</label>
                  <input type="text" class="ios-input" id="employee_id" placeholder="กรอกรหัสพนักงาน">
                </div>
              </div>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label required">ตำแหน่ง</label>
                  <select class="ios-select" id="employee_position">
                    <option value="">เลือกตำแหน่ง</option>
                    <option value="BM">BM</option>
                    <option value="Wealth">Wealth</option>
                    <option value="CISA">CISA</option>
                    <option value="CFSA">CFSA</option>
                    <option value="Yindee">Yindee</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div class="ios-input-group">
                  <label class="ios-label required">RH</label>
                  <select class="ios-select" id="rh">
                    <option value="">เลือก RH</option>
                    <option value="RH1">RH1</option>
                    <option value="RH2">RH2</option>
                    <option value="RH3">RH3</option>
                    <option value="RH4">RH4</option>
                    <option value="RH5">RH5</option>
                  </select>
                </div>
              </div>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label required">Zone</label>
                  <select class="ios-select" id="zone" disabled>
                    <option value="">เลือก RH ก่อน</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Customer Personal Information -->
            <div class="form-section">
              <h3 class="section-header">
                <i class="fas fa-user"></i>
                ข้อมูลส่วนตัวลูกค้า
              </h3>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label required">ชื่อนามสมมุติ</label>
                  <input type="text" class="ios-input" id="cust_name" placeholder="กรอกชื่อลูกค้า">
                  <div class="unknown-checkbox">
                    <input type="checkbox" id="cust_name_unknown">
                    <label for="cust_name_unknown">ไม่ทราบ/ไม่มีข้อมูล</label>
                  </div>
                </div>
                <div class="ios-input-group">
                  <label class="ios-label required">อายุ</label>
                  <input type="number" class="ios-input" id="cust_age" placeholder="กรอกอายุ">
                  <div class="unknown-checkbox">
                    <input type="checkbox" id="cust_age_unknown">
                    <label for="cust_age_unknown">ไม่ทราบ/ไม่มีข้อมูล</label>
                  </div>
                </div>
              </div>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label required">เพศ</label>
                  <select class="ios-select" id="cust_gender">
                    <option value="">เลือกเพศ</option>
                    <option>ชาย</option>
                    <option>หญิง</option>
                    <option>อื่นๆ</option>
                  </select>
                  <div class="unknown-checkbox">
                    <input type="checkbox" id="cust_gender_unknown">
                    <label for="cust_gender_unknown">ไม่ทราบ/ไม่มีข้อมูล</label>
                  </div>
                </div>
                <div class="ios-input-group">
                  <label class="ios-label required">อาชีพ</label>
                  <select class="ios-select" id="cust_occupation">
                    <option value="">เลือกอาชีพ</option>
                    <option>พนักงานบริษัท</option>
                    <option>ข้าราชการ</option>
                    <option>เจ้าของกิจการ/ธุรกิจส่วนตัว</option>
                    <option>แพทย์</option>
                    <option>วิศวกร</option>
                    <option>ครู</option>
                    <option>นักกฎหมาย</option>
                    <option>อื่นๆ</option>
                  </select>
                  <div class="unknown-checkbox">
                    <input type="checkbox" id="cust_occupation_unknown">
                    <label for="cust_occupation_unknown">ไม่ทราบ/ไม่มีข้อมูล</label>
                  </div>
                </div>
              </div>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label required">รายได้ต่อเดือน (บาท)</label>
                  <input type="number" class="ios-input" id="cust_monthly_income" placeholder="กรอกรายได้ต่อเดือน">
                  <div class="unknown-checkbox">
                    <input type="checkbox" id="cust_monthly_income_unknown">
                    <label for="cust_monthly_income_unknown">ไม่ทราบ/ไม่มีข้อมูล</label>
                  </div>
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">รายได้ต่อปี (บาท)</label>
                  <input type="text" class="ios-input" id="cust_yearly_income" readonly placeholder="คำนวณอัตโนมัติ">
                </div>
              </div>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label">มีสวัสดิการหรือไม่</label>
                  <select class="ios-select" id="cust_welfare">
                    <option value="">เลือก</option>
                    <option>ไม่มี</option>
                    <option>มี - วงเงินสูง</option>
                    <option>มี - วงเงินกลาง</option>
                    <option>มี - วงเงินต่ำ</option>
                    <option>มี - ทุนประกันต่อปี</option>
                  </select>
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">ทุนประกันต่อปี (บาท)</label>
                  <input type="number" class="ios-input" id="cust_insurance_capital" placeholder="กรอกทุนประกัน">
                </div>
              </div>
            </div>

            <!-- Family Information -->
            <div class="form-section">
              <h3 class="section-header">
                <i class="fas fa-users"></i>
                ข้อมูลครอบครัว
              </h3>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label">สถานภาพ</label>
                  <select class="ios-select" id="cust_marital_status">
                    <option value="">เลือกสถานภาพ</option>
                    <option>โสด</option>
                    <option>สมรส</option>
                    <option>หม้าย</option>
                    <option>หย่า</option>
                  </select>
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">อายุคู่สมรส</label>
                  <input type="number" class="ios-input" id="cust_spouse_age" placeholder="กรอกอายุคู่สมรส">
                </div>
              </div>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label">อาชีพคู่สมรส</label>
                  <select class="ios-select" id="cust_spouse_occupation">
                    <option value="">เลือกอาชีพ</option>
                    <option>ไม่มี</option>
                    <option>พนักงานบริษัท</option>
                    <option>ข้าราชการ</option>
                    <option>เจ้าของกิจการ/ธุรกิจส่วนตัว</option>
                    <option>แพทย์</option>
                    <option>วิศวกร</option>
                    <option>ครู</option>
                    <option>แม่บ้าน</option>
                    <option>อื่นๆ</option>
                  </select>
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">มีบุตรหรือไม่</label>
                  <select class="ios-select" id="cust_has_children">
                    <option value="">เลือก</option>
                    <option>ไม่มี</option>
                    <option>มี</option>
                  </select>
                </div>
              </div>
              <div id="children-section" style="display: none;">
                <div class="form-grid">
                  <div class="ios-input-group">
                    <label class="ios-label">จำนวนบุตร</label>
                    <input type="number" class="ios-input" id="cust_children_count" placeholder="กรอกจำนวนบุตร">
                  </div>
                  <div class="ios-input-group">
                    <label class="ios-label">อายุบุตร</label>
                    <input type="text" class="ios-input" id="cust_children_ages" placeholder="เช่น 8,5,2">
                  </div>
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">อาชีพบุตร</label>
                  <select class="ios-select" id="cust_children_occupation">
                    <option value="">เลือกอาชีพ</option>
                    <option>นักเรียน</option>
                    <option>นักศึกษา</option>
                    <option>พนักงานบริษัท</option>
                    <option>อื่นๆ</option>
                  </select>
                </div>
              </div>
              <div class="ios-input-group">
                <label class="ios-label">มีบุคคลอื่นที่ต้องดูแลหรือไม่</label>
                <select class="ios-select" id="cust_has_dependents">
                  <option value="">เลือก</option>
                    <option>ไม่มี</option>
                    <option>มี</option>
                </select>
              </div>
              <div id="dependents-section" style="display: none;">
                <div class="ios-input-group">
                  <label class="ios-label">รายละเอียดบุคคลที่ต้องดูแล</label>
                  <textarea class="ios-input" id="cust_dependents_details" rows="3" placeholder="กรอกรายละเอียด"></textarea>
                </div>
              </div>
            </div>

            <!-- Business Information -->
            <div class="form-section" id="business-section" style="display: none;">
              <h3 class="section-header">
                <i class="fas fa-briefcase"></i>
                ข้อมูลธุรกิจ
              </h3>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label">ประเภทธุรกิจ/กิจการ</label>
                  <input type="text" class="ios-input" id="cust_business_type" placeholder="กรอกประเภทธุรกิจ">
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">ทุนจดทะเบียน (บาท)</label>
                  <input type="number" class="ios-input" id="cust_business_capital" placeholder="กรอกทุนจดทะเบียน">
                </div>
              </div>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label">รายได้ต่อปี (บาท)</label>
                  <input type="number" class="ios-input" id="cust_business_income" placeholder="กรอกรายได้ต่อปี">
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">กำไร (บาท)</label>
                  <input type="number" class="ios-input" id="cust_business_profit" placeholder="กรอกกำไร">
                </div>
              </div>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label">ภาษีที่เสียปีล่าสุด (บาท)</label>
                  <input type="number" class="ios-input" id="cust_business_tax" placeholder="กรอกภาษี">
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">สัดส่วนหุ้นที่ถือครอง (%)</label>
                  <input type="number" class="ios-input" id="cust_business_share" placeholder="กรอกสัดส่วนหุ้น" min="0" max="100">
                </div>
              </div>
            </div>

            <!-- Financial Products -->
            <div class="form-section">
              <h3 class="section-header">
                <i class="fas fa-piggy-bank"></i>
                ผลิตภัณฑ์ทางการเงินที่ถือครอง
              </h3>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label">เงินฝากออมทรัพย์ (บาท)</label>
                  <input type="number" class="ios-input" id="prod_savings" placeholder="กรอกจำนวนเงิน">
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">เงินฝากประจำ (บาท)</label>
                  <input type="number" class="ios-input" id="prod_fixed" placeholder="กรอกจำนวนเงิน">
                </div>
              </div>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label">กองทุน (บาท)</label>
                  <input type="number" class="ios-input" id="prod_fund" placeholder="กรอกจำนวนเงิน">
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">บัตรเครดิต (บาท)</label>
                  <input type="number" class="ios-input" id="prod_credit_card" placeholder="กรอกจำนวนเงิน">
                </div>
              </div>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label">เงินกู้บ้าน (บาท)</label>
                  <input type="number" class="ios-input" id="prod_home_loan" placeholder="กรอกจำนวนเงิน">
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">เงินกู้รถ (บาท)</label>
                  <input type="number" class="ios-input" id="prod_car_loan" placeholder="กรอกจำนวนเงิน">
                </div>
              </div>
              <div class="ios-input-group">
                <label class="ios-label">เงินกู้ส่วนบุคคล (บาท)</label>
                <input type="number" class="ios-input" id="prod_personal_loan" placeholder="กรอกจำนวนเงิน">
              </div>
            </div>

            <!-- Insurance Policies Section -->
            <div class="form-section">
              <h3 class="section-header">
                <i class="fas fa-file-contract"></i>
                ข้อมูลประกันชีวิตที่มีอยู่
              </h3>
              <div id="insurance-policies-container">
                <!-- Policies will be added here dynamically -->
              </div>
              <div style="display: flex; gap: 12px; margin-top: 12px;">
                <button type="button" class="ios-btn ios-btn-secondary" id="btn-add-policy" style="flex: 1;">
                  <i class="fas fa-plus"></i>
                  เพิ่มกรมธรรม์
                </button>
                <button type="button" class="ios-btn ios-btn-secondary no-insurance-btn" id="btn-no-insurance" style="flex: 1;">
                  <i class="fas fa-times"></i>
                  ไม่มีประกันชีวิต
                </button>
              </div>
            </div>

            <!-- AI Analysis Section -->
            <div class="form-section">
              <h3 class="section-header">
                <i class="fas fa-robot"></i>
                AI Insurance Advisor
              </h3>
              <div style="text-align: center; padding: 20px;">
                <button class="ios-btn ios-btn-primary" id="btnAnalyze" style="padding: 16px 32px; font-size: 17px;" disabled>
                  <i class="fas fa-magic"></i>
                  วิเคราะห์ด้วย AI
                </button>
                <p style="color: var(--text-secondary); margin-top: 12px; font-size: 15px;">
                  ระบบจะวิเคราะห์ข้อมูลและแนะนำผลิตภัณฑ์ที่เหมาะสมที่สุด
                </p>
              </div>
            </div>

            <!-- Employee Comments -->
            <div class="form-section">
              <h3 class="section-header">
                <i class="fas fa-comments"></i>
                ความเห็นพนักงาน
              </h3>
              <div class="ios-input-group">
                <label class="ios-label">ความเห็นเพิ่มเติม</label>
                <textarea class="ios-input" id="emp_additional_comments" rows="3" placeholder="กรอกความเห็นเพิ่มเติม"></textarea>
              </div>
              <div class="ios-input-group">
                <label class="ios-label">เคยนำเสนอผลิตภัณฑ์แล้วหรือไม่</label>
                <select class="ios-select" id="emp_presented_before">
                  <option value="">เลือก</option>
                  <option>ยังไม่เคยนำเสนอ</option>
                  <option>เคยนำเสนอแล้ว</option>
                  <option>เคยนำเสนอมากกว่า 3 ครั้ง</option>
                </select>
              </div>
              <div class="ios-input-group">
                <label class="ios-label">ลูกค้าเคยโต้แย้งหรือมีความคิดเห็นอย่างไร</label>
                <textarea class="ios-input" id="emp_customer_feedback" rows="2" placeholder="กรอกความคิดเห็นลูกค้า"></textarea>
              </div>
              <div class="form-grid">
                <div class="ios-input-group">
                  <label class="ios-label">ผลิตภัณฑ์ที่จะนำเสนอ</label>
                  <input type="text" class="ios-input" id="emp_proposed_product" placeholder="กรอกผลิตภัณฑ์">
                </div>
                <div class="ios-input-group">
                  <label class="ios-label">เบี้ยประกันที่คาดหวัง (บาท)</label>
                  <input type="number" class="ios-input" id="emp_proposed_premium" placeholder="กรอกเบี้ยประกัน">
                </div>
              </div>
              <div class="ios-input-group">
                <label class="ios-label">ทุนประกันที่คาดหวัง (บาท)</label>
                <input type="number" class="ios-input" id="emp_proposed_capital" placeholder="กรอกทุนประกัน">
              </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 12px; margin-top: 24px;">
              <button class="ios-btn ios-btn-secondary" id="btnClear" style="flex: 1;">
                <i class="fas fa-broom"></i>
                ล้างข้อมูล
              </button>
              <button class="ios-btn ios-btn-primary" id="btnSave" style="flex: 1;">
                <i class="fas fa-save"></i>
                บันทึกข้อมูล
              </button>
            </div>

            <!-- Form Status -->
            <div class="form-status" id="formStatus"></div>
          </div>
        </div>

        <!-- Analysis Results -->
        <div class="ios-card" id="analysisResults" style="display: none;">
          <div class="ios-card-header">
            <h2 class="ios-card-title">
              <i class="fas fa-chart-line" style="color: var(--green);"></i>
              ผลการวิเคราะห์
            </h2>
            <p class="ios-card-subtitle">คำแนะนำจากระบบ AI Advisor</p>
          </div>
          <div class="ios-card-body">
            <div class="recommendation-grid" id="recommendationList">
              <!-- Recommendations will be inserted here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Search Panel -->
      <div id="panel-search" class="content-panel">
        <div class="ios-card">
          <div class="ios-card-header">
            <h2 class="ios-card-title">
              <i class="fas fa-search" style="color: var(--primary);"></i>
              ค้นหาข้อมูลลูกค้า
            </h2>
          </div>
          <div class="ios-card-body">
            <!-- Search Filters -->
            <div class="search-filters">
              <div class="ios-input-group">
                <label class="ios-label">RH</label>
                <select class="ios-select" id="search_rh">
                  <option value="">ทั้งหมด</option>
                  <option value="RH1">RH1</option>
                  <option value="RH2">RH2</option>
                  <option value="RH3">RH3</option>
                  <option value="RH4">RH4</option>
                  <option value="RH5">RH5</option>
                </select>
              </div>
              <div class="ios-input-group">
                <label class="ios-label">Zone</label>
                <select class="ios-select" id="search_zone">
                  <option value="">ทั้งหมด</option>
                </select>
              </div>
              <div class="ios-input-group">
                <label class="ios-label">ชื่อพนักงาน</label>
                <input type="text" class="ios-input" id="search_employee_name" placeholder="ค้นหาชื่อพนักงาน">
              </div>
              <div class="ios-input-group">
                <label class="ios-label">รหัสพนักงาน</label>
                <input type="text" class="ios-input" id="search_employee_id" placeholder="ค้นหารหัสพนักงาน">
              </div>
              <div class="ios-input-group">
                <label class="ios-label">ชื่อลูกค้า</label>
                <input type="text" class="ios-input" id="search_customer_name" placeholder="ค้นหาชื่อลูกค้า">
              </div>
              <div class="ios-input-group">
                <label class="ios-label">Customer ID</label>
                <input type="text" class="ios-input" id="search_customer_id" placeholder="ค้นหา Customer ID">
              </div>
            </div>

            <!-- Search Actions -->
            <div style="display: flex; gap: 12px; margin-bottom: 16px;">
              <button class="ios-btn ios-btn-secondary" id="btnClearSearch" style="flex: 1;">
                <i class="fas fa-broom"></i>
                ล้างการค้นหา
              </button>
              <button class="ios-btn ios-btn-primary" id="btnSearch" style="flex: 1;">
                <i class="fas fa-search"></i>
                ค้นหา
              </button>
            </div>

            <!-- Customer List -->
            <div class="customer-list" id="customerList">
              <div class="search-placeholder">
                <i class="fas fa-search" style="font-size: 48px; margin-bottom: 16px; color: var(--gray-4);"></i>
                <p>กรุณาใช้ฟิลเตอร์ด้านบนเพื่อค้นหาข้อมูลลูกค้า</p>
                <small style="color: var(--text-secondary);">ระบบจะแสดงข้อมูลเฉพาะเมื่อค้นหาแล้วเท่านั้น</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Report Panel -->
      <div id="panel-report" class="content-panel">
        <div class="ios-card">
          <div class="ios-card-header">
            <h2 class="ios-card-title">
              <i class="fas fa-chart-bar" style="color: var(--primary);"></i>
              รายงานและสถิติ
            </h2>
          </div>
          <div class="ios-card-body">
            <!-- Security Notice -->
            <div style="text-align: center; padding: 20px; background: var(--light-blue-bg); border-radius: 10px; margin-bottom: 20px;">
              <i class="fas fa-lock" style="font-size: 24px; color: var(--primary); margin-bottom: 8px;"></i>
              <p>เมนูนี้ต้องการการยืนยันตัวตนก่อนเข้าใช้งาน</p>
              <button class="ios-btn ios-btn-primary" id="btnAccessReport" style="margin-top: 12px;">
                <i class="fas fa-key"></i>
                ยืนยันตัวตน
              </button>
            </div>

            <!-- Report Content (Initially Hidden) -->
            <div id="reportContent" style="display: none;">
              <!-- Dashboard Stats -->
              <div class="dashboard-grid">
                <div class="stat-card">
                  <div class="stat-value" id="reportTotalCustomers">0</div>
                  <div class="stat-label">ลูกค้าทั้งหมด</div>
                </div>
                <div class="stat-card">
                  <div class="stat-value" id="reportMTD">0</div>
                  <div class="stat-label">ลูกค้าเดือนนี้</div>
                </div>
                <div class="stat-card">
                  <div class="stat-value" id="reportByRH">0</div>
                  <div class="stat-label">แยกตาม RH</div>
                </div>
                <div class="stat-card">
                  <div class="stat-value" id="reportByPosition">0</div>
                  <div class="stat-label">แยกตามตำแหน่ง</div>
                </div>
              </div>

              <!-- Export Options -->
              <div class="form-section">
                <h3 class="section-header">
                  <i class="fas fa-download"></i>
                  ส่งออกข้อมูล
                </h3>
                <div class="export-options">
                  <button class="ios-btn ios-btn-primary" id="btnExportPDF">
                    <i class="fas fa-file-pdf"></i>
                    Export PDF
                  </button>
                  <button class="ios-btn ios-btn-primary" id="btnExportExcel">
                    <i class="fas fa-file-excel"></i>
                    Export Excel
                  </button>
                </div>
              </div>

              <!-- Data Management -->
              <div class="data-management">
                <h3 class="section-header">
                  <i class="fas fa-database"></i>
                  การจัดการข้อมูล
                </h3>
                <div class="delete-options">
                  <button class="ios-btn ios-btn-secondary" id="btnDeleteSelected">
                    <i class="fas fa-trash"></i>
                    ลบข้อมูลที่เลือก
                  </button>
                  <button class="ios-btn ios-btn-secondary" id="btnDeleteLastMonth">
                    <i class="fas fa-calendar-minus"></i>
                    ลบข้อมูลเดือนล่าสุด
                  </button>
                  <button class="ios-btn ios-btn-secondary" id="btnDeleteOldest">
                    <i class="fas fa-history"></i>
                    ลบข้อมูลเก่าที่สุด
                  </button>
                  <button class="ios-btn ios-btn-secondary" id="btnDeleteAll">
                    <i class="fas fa-bomb"></i>
                    ลบข้อมูลทั้งหมด
                  </button>
                </div>
                <div class="delete-warning" id="deleteWarning" style="display: none;">
                  <i class="fas fa-exclamation-triangle"></i>
                  การลบข้อมูลไม่สามารถกู้คืนได้ กรุณายืนยันอีกครั้ง
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Security Modal -->
  <div class="security-modal" id="securityModal" style="display: none;">
    <div class="security-content">
      <h3 style="margin-bottom: 16px; text-align: center;">ยืนยันตัวตน</h3>
      <div class="ios-input-group">
        <label class="ios-label">รหัสผ่าน</label>
        <input type="password" class="ios-input" id="securityPassword" placeholder="กรอกรหัสผ่าน">
      </div>
      <div style="display: flex; gap: 12px; margin-top: 16px;">
        <button class="ios-btn ios-btn-secondary" id="btnCancelSecurity" style="flex: 1;">
          ยกเลิก
        </button>
        <button class="ios-btn ios-btn-primary" id="btnConfirmSecurity" style="flex: 1;">
          ยืนยัน
        </button>
      </div>
    </div>
  </div>

  <!-- Customer Detail Modal -->
  <div class="customer-detail-modal" id="customerDetailModal" style="display: none;">
    <div class="modal-overlay" id="customerModalOverlay"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3>รายละเอียดลูกค้า</h3>
        <button class="close-btn" id="closeCustomerModal">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body" id="customerDetailContent">
        <!-- Customer details will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Customer Access Modal -->
  <div class="security-modal" id="customerAccessModal" style="display: none;">
    <div class="security-content">
      <h3 style="margin-bottom: 16px; text-align: center;">ยืนยันตัวตนเพื่อเข้าถึงข้อมูล</h3>
      <div class="ios-input-group">
        <label class="ios-label">รหัสผ่าน</label>
        <input type="password" class="ios-input" id="customerAccessPassword" placeholder="กรอกรหัสพนักงานหรือรหัสพิเศษ">
        <small style="color: var(--text-secondary); margin-top: 4px;">กรอกรหัสพนักงานที่สร้างข้อมูล หรือรหัสพิเศษ "0229"</small>
      </div>
      <div style="display: flex; gap: 12px; margin-top: 16px;">
        <button class="ios-btn ios-btn-secondary" id="btnCancelCustomerAccess" style="flex: 1;">
          ยกเลิก
        </button>
        <button class="ios-btn ios-btn-primary" id="btnConfirmCustomerAccess" style="flex: 1;">
          ยืนยัน
        </button>
      </div>
    </div>
  </div>

  <script>
    // =============================================
    // System Configuration
    // =============================================
    const SUPABASE_URL = 'https://gqcecpvtzxznnabhfgvw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxY2VjcHZ0enh6bm5hYmhmZ3Z3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2Mzg4MTAsImV4cCI6MjA4MjIxNDgxMH0.uYj6nI1EGgOXDBkZn1jgS1DjUZsEy-ChM0JlRw_d7-s';

    // Security Passcodes
    const REPORT_PASSCODE = "2025";
    const SPECIAL_PASSCODE = "0229";

    // Initialize Supabase Client
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // DOM Helper
    const $ = (id) => document.getElementById(id);

    // System State
    let currentPanel = 'start';
    let currentCustomerId = '';
    let selectedCustomer = null;
    let customersData = [];
    let policyCount = 0;
    let policyForms = [];

    // =============================================
    // Insurance Advisor Classes
    // =============================================

    class InsuranceAdvisor {
      constructor() {
        this.products = this.initializeProducts();
      }

      initializeProducts() {
        return {
          'ประกันสุขภาพ IPD': { category: 'health', minAge: 0, maxAge: 70, priority: 1 },
          'ประกันสุขภาพ OPD': { category: 'health', minAge: 0, maxAge: 65, priority: 2 },
          'ประกันโรคร้ายแรง': { category: 'health', minAge: 25, maxAge: 60, priority: 3 },
          'ประกันโรคมะเร็ง': { category: 'health', minAge: 20, maxAge: 65, priority: 4 },
          'ประกันชีวิตแบบสะสมทรัพย์': { category: 'life', minAge: 20, maxAge: 55, priority: 5 },
          'ประกันชีวิตแบบตลอดชีพ': { category: 'life', minAge: 25, maxAge: 50, priority: 6 },
          'ประกันชีวิตแบบชั่วระยะเวลา': { category: 'life', minAge: 20, maxAge: 60, priority: 7 },
          'ประกันอุบัติเหตุส่วนบุคคล': { category: 'accident', minAge: 18, maxAge: 65, priority: 8 },
          'ประกันทุพพลภาพ': { category: 'accident', minAge: 20, maxAge: 55, priority: 9 },
          'ประกันบำนาญ': { category: 'retirement', minAge: 30, maxAge: 50, priority: 10 },
          'ประกันการศึกษา': { category: 'savings', minAge: 25, maxAge: 45, priority: 11 }
        };
      }

      analyzeCustomer(customer) {
        const recommendations = [];
        const age = customer.cust_age || 0;
        const monthlyIncome = customer.cust_monthly_income || 0;
        const occupation = customer.cust_occupation || '';
        const hasChildren = customer.cust_has_children === 'มี';
        const maritalStatus = customer.cust_marital_status || '';

        // Rule 1: Health insurance based on age
        if (age >= 30) {
          recommendations.push({
            product: 'ประกันโรคร้ายแรง',
            score: 85,
            capital: monthlyIncome * 12 * 3,
            premium: Math.round(monthlyIncome * 0.05),
            reason: `อายุ ${age} ปี เป็นกลุ่มเสี่ยงโรคเรื้อรัง`
          });
        }

        // Rule 2: Life insurance based on income and family status
        if (monthlyIncome > 30000 && (maritalStatus === 'สมรส' || hasChildren)) {
          recommendations.push({
            product: 'ประกันชีวิตแบบสะสมทรัพย์',
            score: 80,
            capital: monthlyIncome * 12 * 5,
            premium: Math.round(monthlyIncome * 0.08),
            reason: `รายได้ ${monthlyIncome.toLocaleString()} บาท/เดือน ${hasChildren ? 'และมีบุตร' : 'และมีครอบครัว'}`
          });
        }

        // Rule 3: Accident insurance for certain occupations
        const highRiskOccupations = ['แพทย์', 'วิศวกร', 'เจ้าของกิจการ/ธุรกิจส่วนตัว'];
        if (highRiskOccupations.includes(occupation)) {
          recommendations.push({
            product: 'ประกันอุบัติเหตุส่วนบุคคล',
            score: 75,
            capital: monthlyIncome * 12 * 2,
            premium: Math.round(monthlyIncome * 0.02),
            reason: `อาชีพ ${occupation} มีความเสี่ยงด้านอุบัติเหตุสูง`
          });
        }

        // Rule 4: Education insurance if has children
        if (hasChildren) {
          recommendations.push({
            product: 'ประกันการศึกษา',
            score: 70,
            capital: 1000000,
            premium: Math.round(monthlyIncome * 0.03),
            reason: 'วางแผนการศึกษาบุตร'
          });
        }

        // Rule 5: Basic health insurance for everyone
        recommendations.push({
          product: 'ประกันสุขภาพ IPD',
          score: 90,
          capital: 500000,
          premium: Math.round(monthlyIncome * 0.04),
          reason: 'ความคุ้มครองพื้นฐานสำหรับค่ารักษาพยาบาล'
        });

        // Sort by score
        return recommendations.sort((a, b) => b.score - a.score);
      }

      calculateRiskScore(customer) {
        let score = 0;
        const age = customer.cust_age || 0;
        const income = customer.cust_monthly_income || 0;
        const occupation = customer.cust_occupation || '';
        const hasChildren = customer.cust_has_children === 'มี';
        const maritalStatus = customer.cust_marital_status || '';

        // Age factor
        if (age >= 40) score += 3;
        else if (age >= 30) score += 2;
        else if (age >= 20) score += 1;

        // Income factor
        if (income > 100000) score += 3;
        else if (income > 50000) score += 2;
        else if (income > 25000) score += 1;

        // Occupation risk
        const highRiskOccupations = ['แพทย์', 'วิศวกร', 'เจ้าของกิจการ/ธุรกิจส่วนตัว'];
        if (highRiskOccupations.includes(occupation)) score += 2;

        // Family responsibility
        if (maritalStatus === 'สมรส') score += 1;
        if (hasChildren) score += 2;

        return Math.min(score, 10);
      }
    }

    // =============================================
    // Application Initialization
    // =============================================

    async function initializeApp() {
      try {
        // Test Supabase connection
        const { data, error } = await supabase
          .from('employees')
          .select('count')
          .limit(1);

        if (error) throw error;

        console.log('✅ Connected to Supabase successfully');
        
        // Simulate loading progress
        simulateLoading();
        
      } catch (error) {
        console.error('❌ Failed to connect to Supabase:', error);
        showError('ไม่สามารถเชื่อมต่อกับฐานข้อมูลได้');
      }
    }

    function simulateLoading() {
      let progress = 0;
      const progressBar = $('loadingProgress');
      const interval = setInterval(() => {
        progress += 5;
        progressBar.style.width = `${progress}%`;
        
        if (progress >= 100) {
          clearInterval(interval);
          setTimeout(() => {
            $('loadingScreen').style.opacity = '0';
            setTimeout(() => {
              $('loadingScreen').style.display = 'none';
              $('appContainer').style.display = 'flex';
              setupEventListeners();
              loadDashboardStats();
            }, 600);
          }, 300);
        }
      }, 100);
    }

    // =============================================
    // Event Listeners Setup
    // =============================================

    function setupEventListeners() {
      // Tab Navigation
      document.querySelectorAll('.ios-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const panel = tab.getAttribute('data-panel');
          switchPanel(panel);
        });
      });

      // Start Button
      $('btnStart').addEventListener('click', () => {
        switchPanel('form');
      });

      // Form Calculations
      $('cust_monthly_income').addEventListener('input', calculateYearlyIncome);
      $('cust_occupation').addEventListener('change', toggleBusinessSection);
      $('cust_has_children').addEventListener('change', toggleChildrenSection);
      $('cust_has_dependents').addEventListener('change', toggleDependentsSection);
      $('rh').addEventListener('change', updateZoneOptions);

      // Unknown checkboxes
      setupUnknownCheckboxes();

      // Insurance Policies
      $('btn-add-policy').addEventListener('click', addPolicyForm);
      $('btn-no-insurance').addEventListener('click', clearAllPolicies);

      // Form Actions
      $('btnAnalyze').addEventListener('click', performAnalysis);
      $('btnSave').addEventListener('click', saveCustomer);
      $('btnClear').addEventListener('click', clearForm);

      // Search Functionality
      $('btnSearch').addEventListener('click', searchCustomers);
      $('btnClearSearch').addEventListener('click', clearSearch);

      // Report Functions
      $('btnAccessReport').addEventListener('click', showSecurityModal);
      $('btnConfirmSecurity').addEventListener('click', verifyReportAccess);
      $('btnCancelSecurity').addEventListener('click', hideSecurityModal);

      // Logout
      $('btnLogout').addEventListener('click', () => {
        if (confirm('ต้องการออกจากระบบใช่หรือไม่?')) {
          location.reload();
        }
      });
    }

    // =============================================
    // Form Functions
    // =============================================

    function calculateYearlyIncome() {
      const monthlyIncome = parseFloat($('cust_monthly_income').value) || 0;
      const yearlyIncome = monthlyIncome * 12;
      $('cust_yearly_income').value = yearlyIncome.toLocaleString();
    }

    function toggleBusinessSection() {
      const occupation = $('cust_occupation').value;
      const businessSection = $('business-section');
      businessSection.style.display = occupation === 'เจ้าของกิจการ/ธุรกิจส่วนตัว' ? 'block' : 'none';
    }

    function toggleChildrenSection() {
      const hasChildren = $('cust_has_children').value;
      $('children-section').style.display = hasChildren === 'มี' ? 'block' : 'none';
    }

    function toggleDependentsSection() {
      const hasDependents = $('cust_has_dependents').value;
      $('dependents-section').style.display = hasDependents === 'มี' ? 'block' : 'none';
    }

    function updateZoneOptions() {
      const rh = $('rh').value;
      const zoneSelect = $('zone');
      
      if (!rh) {
        zoneSelect.innerHTML = '<option value="">เลือก RH ก่อน</option>';
        zoneSelect.disabled = true;
        return;
      }

      zoneSelect.disabled = false;
      let options = '<option value="">เลือก Zone</option>';
      
      // Map RH to zones
      const zoneMap = {
        'RH1': ['ZONE1', 'ZONE2', 'ZONE3'],
        'RH2': ['ZONE4', 'ZONE5', 'ZONE6'],
        'RH3': ['ZONE7', 'ZONE8', 'ZONE9'],
        'RH4': ['ZONE10', 'ZONE11', 'ZONE12'],
        'RH5': ['ZONE13', 'ZONE14', 'ZONE15']
      };

      if (zoneMap[rh]) {
        zoneMap[rh].forEach(zone => {
          options += `<option value="${zone}">${zone}</option>`;
        });
      }

      zoneSelect.innerHTML = options;
    }

    function setupUnknownCheckboxes() {
      const checkboxes = [
        { checkbox: 'cust_name_unknown', field: 'cust_name' },
        { checkbox: 'cust_age_unknown', field: 'cust_age' },
        { checkbox: 'cust_gender_unknown', field: 'cust_gender' },
        { checkbox: 'cust_occupation_unknown', field: 'cust_occupation' },
        { checkbox: 'cust_monthly_income_unknown', field: 'cust_monthly_income' }
      ];

      checkboxes.forEach(item => {
        $(item.checkbox).addEventListener('change', function() {
          const field = $(item.field);
          if (this.checked) {
            field.value = '';
            field.disabled = true;
            if (field.tagName === 'SELECT') {
              field.selectedIndex = 0;
            }
          } else {
            field.disabled = false;
          }
        });
      });
    }

    // =============================================
    // Insurance Policies Functions
    // =============================================

    function addPolicyForm() {
      policyCount++;
      const policyId = `policy-${policyCount}`;
      
      const policyForm = document.createElement('div');
      policyForm.className = 'policy-item';
      policyForm.id = policyId;
      policyForm.innerHTML = `
        <div class="policy-form">
          <div class="ios-input-group">
            <label class="ios-label required">ประเภทกรมธรรม์</label>
            <select class="ios-select" name="policy_type">
              <option value="">เลือกประเภท</option>
              <option>ประกันชีวิตแบบสะสมทรัพย์</option>
              <option>ประกันตลอดชีพ</option>
              <option>ประกันชั่วระยะเวลา</option>
              <option>ประกันสุขภาพ</option>
              <option>ประกันอุบัติเหตุ</option>
              <option>ประกันโรคร้ายแรง</option>
              <option>ประกันบำนาญ</option>
              <option>ประกันการศึกษา</option>
            </select>
          </div>
          <div class="ios-input-group">
            <label class="ios-label">เบี้ยประกัน (บาท)</label>
            <input type="number" class="ios-input" name="premium_amount" placeholder="กรอกเบี้ยประกัน">
          </div>
          <div class="ios-input-group">
            <label class="ios-label">ทุนประกัน (บาท)</label>
            <input type="number" class="ios-input" name="sum_insured" placeholder="กรอกทุนประกัน">
          </div>
          <div class="ios-input-group">
            <label class="ios-label">เลขที่กรมธรรม์</label>
            <input type="text" class="ios-input" name="policy_number" placeholder="กรอกเลขที่กรมธรรม์">
          </div>
        </div>
        <button type="button" class="ios-btn ios-btn-secondary btn-remove-policy" onclick="removePolicyForm('${policyId}')">
          <i class="fas fa-trash"></i>
          ลบกรมธรรม์นี้
        </button>
      `;
      
      $('insurance-policies-container').appendChild(policyForm);
      policyForms.push(policyId);
    }

    function removePolicyForm(policyId) {
      const policyElement = $(policyId);
      if (policyElement) {
        policyElement.remove();
        policyForms = policyForms.filter(id => id !== policyId);
      }
    }

    function clearAllPolicies() {
      policyForms.forEach(policyId => {
        const policyElement = $(policyId);
        if (policyElement) policyElement.remove();
      });
      policyForms = [];
      
      // Show confirmation
      showMessage('ล้างข้อมูลกรมธรรม์ทั้งหมดแล้ว', 'success');
    }

    function collectPolicyData() {
      const policies = [];
      policyForms.forEach(policyId => {
        const policyElement = $(policyId);
        if (policyElement) {
          const policyData = {
            policy_type: policyElement.querySelector('[name="policy_type"]').value,
            premium_amount: parseFloat(policyElement.querySelector('[name="premium_amount"]').value) || 0,
            sum_insured: parseFloat(policyElement.querySelector('[name="sum_insured"]').value) || 0,
            policy_number: policyElement.querySelector('[name="policy_number"]').value || ''
          };
          
          if (policyData.policy_type) {
            policies.push(policyData);
          }
        }
      });
      return policies;
    }

    // =============================================
    // Analysis Functions
    // =============================================

    async function performAnalysis() {
      try {
        // Disable analyze button and show loading
        $('btnAnalyze').disabled = true;
        $('btnAnalyze').innerHTML = '<span class="loading-spinner"></span> กำลังวิเคราะห์...';
        
        // Collect form data
        const customerData = collectFormData();
        
        // Validate required fields
        if (!validateForm(customerData)) {
          throw new Error('กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน');
        }
        
        // Perform analysis
        const advisor = new InsuranceAdvisor();
        const recommendations = advisor.analyzeCustomer(customerData);
        const riskScore = advisor.calculateRiskScore(customerData);
        
        // Display results
        displayAnalysisResults(recommendations, riskScore);
        
        // Show success message
        showMessage('วิเคราะห์ข้อมูลสำเร็จ!', 'success');
        
      } catch (error) {
        console.error('Analysis error:', error);
        showMessage(`เกิดข้อผิดพลาด: ${error.message}`, 'error');
      } finally {
        // Re-enable button
        $('btnAnalyze').disabled = false;
        $('btnAnalyze').innerHTML = '<i class="fas fa-magic"></i> วิเคราะห์ด้วย AI';
      }
    }

    function collectFormData() {
      return {
        // Employee info
        employee_name: $('employee_name').value,
        employee_id: $('employee_id').value,
        employee_position: $('employee_position').value,
        rh: $('rh').value,
        zone: $('zone').value,
        
        // Customer personal info
        cust_name: $('cust_name').value,
        cust_age: parseInt($('cust_age').value) || 0,
        cust_gender: $('cust_gender').value,
        cust_occupation: $('cust_occupation').value,
        cust_monthly_income: parseFloat($('cust_monthly_income').value) || 0,
        cust_yearly_income: parseFloat($('cust_monthly_income').value) * 12 || 0,
        cust_welfare: $('cust_welfare').value,
        cust_insurance_capital: parseFloat($('cust_insurance_capital').value) || 0,
        
        // Family info
        cust_marital_status: $('cust_marital_status').value,
        cust_spouse_age: parseInt($('cust_spouse_age').value) || 0,
        cust_spouse_occupation: $('cust_spouse_occupation').value,
        cust_has_children: $('cust_has_children').value,
        cust_children_count: parseInt($('cust_children_count').value) || 0,
        cust_children_ages: $('cust_children_ages').value,
        cust_children_occupation: $('cust_children_occupation').value,
        cust_has_dependents: $('cust_has_dependents').value,
        cust_dependents_details: $('cust_dependents_details').value,
        
        // Business info
        cust_business_type: $('cust_business_type').value,
        cust_business_capital: parseFloat($('cust_business_capital').value) || 0,
        cust_business_income: parseFloat($('cust_business_income').value) || 0,
        cust_business_profit: parseFloat($('cust_business_profit').value) || 0,
        cust_business_tax: parseFloat($('cust_business_tax').value) || 0,
        cust_business_share: parseFloat($('cust_business_share').value) || 0,
        
        // Financial products
        prod_savings: parseFloat($('prod_savings').value) || 0,
        prod_fixed: parseFloat($('prod_fixed').value) || 0,
        prod_fund: parseFloat($('prod_fund').value) || 0,
        prod_credit_card: parseFloat($('prod_credit_card').value) || 0,
        prod_home_loan: parseFloat($('prod_home_loan').value) || 0,
        prod_car_loan: parseFloat($('prod_car_loan').value) || 0,
        prod_personal_loan: parseFloat($('prod_personal_loan').value) || 0,
        
        // Employee comments
        emp_additional_comments: $('emp_additional_comments').value,
        emp_presented_before: $('emp_presented_before').value,
        emp_customer_feedback: $('emp_customer_feedback').value,
        emp_proposed_product: $('emp_proposed_product').value,
        emp_proposed_premium: parseFloat($('emp_proposed_premium').value) || 0,
        emp_proposed_capital: parseFloat($('emp_proposed_capital').value) || 0
      };
    }

    function validateForm(data) {
      // Check required employee fields
      if (!data.employee_name || !data.employee_id || !data.employee_position || !data.rh || !data.zone) {
        showMessage('กรุณากรอกข้อมูลพนักงานให้ครบถ้วน', 'error');
        return false;
      }
      
      // Check required customer fields (if not unknown)
      if (!$('cust_name_unknown').checked && !data.cust_name) {
        showMessage('กรุณากรอกชื่อลูกค้า', 'error');
        return false;
      }
      
      if (!$('cust_age_unknown').checked && !data.cust_age) {
        showMessage('กรุณากรอกอายุลูกค้า', 'error');
        return false;
      }
      
      if (!$('cust_gender_unknown').checked && !data.cust_gender) {
        showMessage('กรุณาเลือกเพศลูกค้า', 'error');
        return false;
      }
      
      if (!$('cust_occupation_unknown').checked && !data.cust_occupation) {
        showMessage('กรุณาเลือกอาชีพลูกค้า', 'error');
        return false;
      }
      
      if (!$('cust_monthly_income_unknown').checked && !data.cust_monthly_income) {
        showMessage('กรุณากรอกรายได้ต่อเดือน', 'error');
        return false;
      }
      
      return true;
    }

    function displayAnalysisResults(recommendations, riskScore) {
      const container = $('recommendationList');
      container.innerHTML = '';
      
      // Display risk score
      const riskElement = document.createElement('div');
      riskElement.className = 'ios-card-header';
      riskElement.innerHTML = `
        <h3 class="ios-card-title">
          <i class="fas fa-shield-alt" style="color: ${riskScore >= 7 ? '#FF3B30' : riskScore >= 4 ? '#FF9500' : '#34C759'}"></i>
          ระดับความเสี่ยง: ${riskScore}/10
        </h3>
      `;
      container.appendChild(riskElement);
      
      // Display recommendations
      recommendations.slice(0, 5).forEach((rec, index) => {
        const card = document.createElement('div');
        card.className = 'recommendation-card fade-in';
        card.style.animationDelay = `${index * 0.1}s`;
        
        const urgencyClass = rec.score >= 80 ? 'urgency-critical' : 
                           rec.score >= 70 ? 'urgency-high' : 'urgency-medium';
        
        card.innerHTML = `
          <div class="recommendation-header">
            <div>
              <h4 class="recommendation-title">${rec.product}</h4>
              <span class="urgency-badge ${rec.score >= 80 ? 'critical' : rec.score >= 70 ? 'high' : 'medium'}">
                ${rec.score >= 80 ? 'แนะนำสูง' : rec.score >= 70 ? 'แนะนำปานกลาง' : 'แนะนำพื้นฐาน'}
              </span>
            </div>
            <div class="recommendation-badge">${rec.score}%</div>
          </div>
          <div class="recommendation-details">
            <div class="detail-item">
              <span class="detail-label">ทุนประกันแนะนำ</span>
              <span class="detail-value">${rec.capital.toLocaleString()} บาท</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">เบี้ยประกันประมาณ</span>
              <span class="detail-value">${rec.premium.toLocaleString()} บาท/ปี</span>
            </div>
          </div>
          <p class="recommendation-reason">${rec.reason}</p>
        `;
        
        container.appendChild(card);
      });
      
      // Show results section
      $('analysisResults').style.display = 'block';
    }

    // =============================================
    // Database Operations
    // =============================================

    async function saveCustomer() {
      try {
        // Disable save button and show loading
        const saveBtn = $('btnSave');
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="loading-spinner"></span> กำลังบันทึก...';
        
        // Collect form data
        const customerData = collectFormData();
        const policies = collectPolicyData();
        
        // Validate form
        if (!validateForm(customerData)) {
          throw new Error('กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน');
        }
        
        // Generate customer ID
        const timestamp = new Date().toISOString().replace(/[-:T.]/g, '').slice(0, 14);
        const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
        const customerId = `CUST${timestamp}${randomNum}`;
        
        // Add generated fields
        customerData.customer_id = customerId;
        customerData.created_at = new Date().toISOString();
        customerData.updated_at = new Date().toISOString();
        
        // Save customer to Supabase
        const { data: savedCustomer, error: customerError } = await supabase
          .from('customers')
          .insert([customerData])
          .select()
          .single();
        
        if (customerError) throw customerError;
        
        // Save insurance policies if any
        if (policies.length > 0) {
          const policiesWithCustomerId = policies.map(policy => ({
            ...policy,
            customer_id: savedCustomer.id,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
          }));
          
          const { error: policiesError } = await supabase
            .from('insurance_policies')
            .insert(policiesWithCustomerId);
          
          if (policiesError) throw policiesError;
        }
        
        // Save analysis results if available
        const recommendations = $('recommendationList').innerHTML;
        if (recommendations && recommendations.trim() !== '') {
          const analysisData = {
            customer_id: savedCustomer.id,
            analysis_data: { recommendations: recommendations },
            created_at: new Date().toISOString()
          };
          
          const { error: analysisError } = await supabase
            .from('analysis_results')
            .insert([analysisData]);
          
          if (analysisError) console.warn('Could not save analysis:', analysisError);
        }
        
        // Show success
        showMessage(`บันทึกข้อมูลสำเร็จ! Customer ID: ${customerId}`, 'success');
        
        // Update customer ID display
        $('customerIdDisplay').innerHTML = `
          <i class="fas fa-id-card"></i>
          Customer ID: ${customerId}
        `;
        $('customerIdDisplay').style.display = 'block';
        
        // Clear form after successful save
        setTimeout(() => {
          clearForm();
        }, 3000);
        
      } catch (error) {
        console.error('Save error:', error);
        showMessage(`เกิดข้อผิดพลาด: ${error.message}`, 'error');
      } finally {
        // Re-enable save button
        const saveBtn = $('btnSave');
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save"></i> บันทึกข้อมูล';
      }
    }

    async function searchCustomers() {
      try {
        // Show loading
        $('customerList').innerHTML = '<div class="search-placeholder"><span class="loading-spinner"></span> กำลังค้นหา...</div>';
        
        // Build query
        let query = supabase
          .from('customers')
          .select(`
            *,
            insurance_policies (*)
          `)
          .order('created_at', { ascending: false });
        
        // Apply filters
        const searchRh = $('search_rh').value;
        const searchZone = $('search_zone').value;
        const searchEmployeeName = $('search_employee_name').value;
        const searchEmployeeId = $('search_employee_id').value;
        const searchCustomerName = $('search_customer_name').value;
        const searchCustomerId = $('search_customer_id').value;
        
        if (searchRh) query = query.eq('rh', searchRh);
        if (searchZone) query = query.eq('zone', searchZone);
        if (searchEmployeeName) query = query.ilike('employee_name', `%${searchEmployeeName}%`);
        if (searchEmployeeId) query = query.ilike('employee_id', `%${searchEmployeeId}%`);
        if (searchCustomerName) query = query.ilike('cust_name', `%${searchCustomerName}%`);
        if (searchCustomerId) query = query.ilike('customer_id', `%${searchCustomerId}%`);
        
        // Execute query
        const { data: customers, error } = await query;
        
        if (error) throw error;
        
        // Display results
        displaySearchResults(customers);
        
      } catch (error) {
        console.error('Search error:', error);
        $('customerList').innerHTML = `
          <div class="search-placeholder">
            <i class="fas fa-exclamation-triangle" style="color: var(--red);"></i>
            <p>เกิดข้อผิดพลาดในการค้นหา</p>
            <small>${error.message}</small>
          </div>
        `;
      }
    }

    function displaySearchResults(customers) {
      const container = $('customerList');
      
      if (!customers || customers.length === 0) {
        container.innerHTML = `
          <div class="search-placeholder">
            <i class="fas fa-search" style="font-size: 48px; margin-bottom: 16px; color: var(--gray-4);"></i>
            <p>ไม่พบข้อมูลลูกค้าที่ตรงกับเงื่อนไข</p>
            <small style="color: var(--text-secondary);">ลองเปลี่ยนเงื่อนไขการค้นหา</small>
          </div>
        `;
        return;
      }
      
      container.innerHTML = '';
      
      customers.forEach(customer => {
        const customerElement = document.createElement('div');
        customerElement.className = 'customer-list-item';
        customerElement.dataset.customerId = customer.customer_id;
        
        const policiesCount = customer.insurance_policies?.length || 0;
        const totalPremium = customer.insurance_policies?.reduce((sum, policy) => 
          sum + (policy.premium_amount || 0), 0) || 0;
        
        customerElement.innerHTML = `
          <div class="customer-info">
            <div class="customer-main-info">
              <h4 class="customer-name">${customer.cust_name || 'ไม่ระบุชื่อ'}</h4>
              <span class="customer-id">${customer.customer_id}</span>
            </div>
            <div class="customer-secondary-info">
              <span>อายุ: ${customer.cust_age || 'ไม่ระบุ'} ปี</span>
              <span>อาชีพ: ${customer.cust_occupation || 'ไม่ระบุ'}</span>
              <span>รายได้: ${customer.cust_monthly_income ? customer.cust_monthly_income.toLocaleString() : 'ไม่ระบุ'} บาท/เดือน</span>
              <span>กรมธรรม์: ${policiesCount} รายการ</span>
            </div>
            <div class="customer-secondary-info">
              <span>พนักงาน: ${customer.employee_name} (${customer.employee_id})</span>
              <span>RH: ${customer.rh} | Zone: ${customer.zone}</span>
            </div>
          </div>
          <button class="select-btn" onclick="viewCustomerDetails('${customer.customer_id}')">
            <i class="fas fa-eye"></i>
            ดูรายละเอียด
          </button>
        `;
        
        container.appendChild(customerElement);
      });
    }

    async function viewCustomerDetails(customerId) {
      try {
        // Show loading
        $('customerDetailContent').innerHTML = '<div style="text-align: center; padding: 40px;"><span class="loading-spinner"></span> กำลังโหลดข้อมูล...</div>';
        $('customerDetailModal').style.display = 'flex';
        
        // Fetch customer data with policies
        const { data: customer, error } = await supabase
          .from('customers')
          .select(`
            *,
            insurance_policies (*)
          `)
          .eq('customer_id', customerId)
          .single();
        
        if (error) throw error;
        
        // Display customer details
        displayCustomerDetails(customer);
        
      } catch (error) {
        console.error('Error fetching customer details:', error);
        $('customerDetailContent').innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--red); margin-bottom: 16px;"></i>
            <p>ไม่สามารถโหลดข้อมูลลูกค้าได้</p>
            <small>${error.message}</small>
          </div>
        `;
      }
    }

    function displayCustomerDetails(customer) {
      const policies = customer.insurance_policies || [];
      const policiesHtml = policies.length > 0 
        ? policies.map(policy => `
            <div class="detail-row">
              <span class="detail-label">${policy.policy_type}</span>
              <span class="detail-value">
                เบี้ย: ${policy.premium_amount?.toLocaleString() || 0} บาท<br>
                ทุน: ${policy.sum_insured?.toLocaleString() || 0} บาท
              </span>
            </div>
          `).join('')
        : '<div class="detail-row"><span class="detail-value">ไม่มีข้อมูลกรมธรรม์</span></div>';
      
      $('customerDetailContent').innerHTML = `
        <div class="customer-detail-grid">
          <div class="detail-section">
            <h4 class="detail-section-title"><i class="fas fa-user-tie"></i> ข้อมูลพนักงาน</h4>
            <div class="detail-row">
              <span class="detail-label">ชื่อพนักงาน</span>
              <span class="detail-value">${customer.employee_name}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">รหัสพนักงาน</span>
              <span class="detail-value">${customer.employee_id}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">ตำแหน่ง</span>
              <span class="detail-value">${customer.employee_position}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">RH / Zone</span>
              <span class="detail-value">${customer.rh} / ${customer.zone}</span>
            </div>
          </div>
          
          <div class="detail-section">
            <h4 class="detail-section-title"><i class="fas fa-user"></i> ข้อมูลลูกค้า</h4>
            <div class="detail-row">
              <span class="detail-label">Customer ID</span>
              <span class="detail-value">${customer.customer_id}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">ชื่อนามสมมุติ</span>
              <span class="detail-value">${customer.cust_name || 'ไม่ระบุ'}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">อายุ / เพศ</span>
              <span class="detail-value">${customer.cust_age || 'ไม่ระบุ'} ปี / ${customer.cust_gender || 'ไม่ระบุ'}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">อาชีพ</span>
              <span class="detail-value">${customer.cust_occupation || 'ไม่ระบุ'}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">รายได้ต่อเดือน</span>
              <span class="detail-value">${customer.cust_monthly_income ? customer.cust_monthly_income.toLocaleString() : 'ไม่ระบุ'} บาท</span>
            </div>
          </div>
          
          <div class="detail-section">
            <h4 class="detail-section-title"><i class="fas fa-users"></i> ข้อมูลครอบครัว</h4>
            <div class="detail-row">
              <span class="detail-label">สถานภาพ</span>
              <span class="detail-value">${customer.cust_marital_status || 'ไม่ระบุ'}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">มีบุตร</span>
              <span class="detail-value">${customer.cust_has_children || 'ไม่ระบุ'}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">มีผู้ต้องดูแล</span>
              <span class="detail-value">${customer.cust_has_dependents || 'ไม่ระบุ'}</span>
            </div>
          </div>
          
          <div class="detail-section">
            <h4 class="detail-section-title"><i class="fas fa-file-contract"></i> กรมธรรม์ประกันชีวิต</h4>
            ${policiesHtml}
          </div>
        </div>
        
        <div class="action-buttons">
          <button class="ios-btn ios-btn-secondary cancel-btn" onclick="closeCustomerModal()">
            <i class="fas fa-times"></i>
            ปิด
          </button>
        </div>
      `;
    }

    function closeCustomerModal() {
      $('customerDetailModal').style.display = 'none';
    }

    // =============================================
    // Dashboard Functions
    // =============================================

    async function loadDashboardStats() {
      try {
        // Get total customers
        const { count: totalCustomers, error: countError } = await supabase
          .from('customers')
          .select('*', { count: 'exact', head: true });
        
        if (!countError) {
          $('totalCustomers').textContent = totalCustomers || 0;
          $('reportTotalCustomers').textContent = totalCustomers || 0;
        }
        
        // Get customers this month
        const startOfMonth = new Date();
        startOfMonth.setDate(1);
        startOfMonth.setHours(0, 0, 0, 0);
        
        const { count: mtdCustomers, error: mtdError } = await supabase
          .from('customers')
          .select('*', { count: 'exact', head: true })
          .gte('created_at', startOfMonth.toISOString());
        
        if (!mtdError) {
          $('reportMTD').textContent = mtdCustomers || 0;
        }
        
        // Calculate success rate (placeholder)
        const successRate = totalCustomers > 0 ? Math.min(85, Math.floor(Math.random() * 20) + 75) : 0;
        $('successRate').textContent = `${successRate}%`;
        $('totalAnalysis').textContent = totalCustomers || 0;
        
      } catch (error) {
        console.error('Error loading dashboard stats:', error);
      }
    }

    // =============================================
    // Report Functions
    // =============================================

    function showSecurityModal() {
      $('securityModal').style.display = 'flex';
    }

    function hideSecurityModal() {
      $('securityModal').style.display = 'none';
      $('securityPassword').value = '';
    }

    function verifyReportAccess() {
      const password = $('securityPassword').value;
      
      if (password === REPORT_PASSCODE || password === SPECIAL_PASSCODE) {
        $('reportContent').style.display = 'block';
        hideSecurityModal();
        loadReportData();
      } else {
        alert('รหัสผ่านไม่ถูกต้อง');
        $('securityPassword').value = '';
        $('securityPassword').focus();
      }
    }

    async function loadReportData() {
      try {
        // Load RH statistics
        const { data: rhStats, error: rhError } = await supabase
          .from('customers')
          .select('rh');
        
        if (!rhError && rhStats) {
          const rhCount = {};
          rhStats.forEach(customer => {
            if (customer.rh) {
              rhCount[customer.rh] = (rhCount[customer.rh] || 0) + 1;
            }
          });
          
          const rhStatsText = Object.entries(rhCount)
            .map(([rh, count]) => `${rh}: ${count}`)
            .join(', ');
          
          $('reportByRH').textContent = rhStatsText || 'ไม่มีข้อมูล';
        }
        
        // Load position statistics
        const { data: positionStats, error: positionError } = await supabase
          .from('customers')
          .select('employee_position');
        
        if (!positionError && positionStats) {
          const positionCount = {};
          positionStats.forEach(customer => {
            if (customer.employee_position) {
              positionCount[customer.employee_position] = (positionCount[customer.employee_position] || 0) + 1;
            }
          });
          
          const positionStatsText = Object.entries(positionCount)
            .map(([position, count]) => `${position}: ${count}`)
            .join(', ');
          
          $('reportByPosition').textContent = positionStatsText || 'ไม่มีข้อมูล';
        }
        
      } catch (error) {
        console.error('Error loading report data:', error);
      }
    }

    // =============================================
    // Utility Functions
    // =============================================

    function switchPanel(panelId) {
      // Update tabs
      document.querySelectorAll('.ios-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`.ios-tab[data-panel="${panelId}"]`).classList.add('active');
      
      // Update panels
      document.querySelectorAll('.content-panel').forEach(panel => {
        panel.classList.remove('active');
      });
      $(`panel-${panelId}`).classList.add('active');
      
      // Update current panel
      currentPanel = panelId;
      
      // Load data if needed
      if (panelId === 'search') {
        // Auto-search with current filters
        searchCustomers();
      } else if (panelId === 'report') {
        // Reset report content
        $('reportContent').style.display = 'none';
      }
    }

    function clearForm() {
      // Clear all form fields
      document.querySelectorAll('#panel-form input, #panel-form select, #panel-form textarea').forEach(element => {
        if (element.type !== 'button' && element.type !== 'submit') {
          element.value = '';
          element.disabled = false;
          if (element.tagName === 'SELECT') {
            element.selectedIndex = 0;
          }
        }
      });
      
      // Clear checkboxes
      document.querySelectorAll('#panel-form input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
      });
      
      // Clear insurance policies
      clearAllPolicies();
      
      // Hide analysis results
      $('analysisResults').style.display = 'none';
      $('customerIdDisplay').style.display = 'none';
      
      // Reset sections
      $('business-section').style.display = 'none';
      $('children-section').style.display = 'none';
      $('dependents-section').style.display = 'none';
      $('zone').disabled = true;
      
      // Enable analyze button
      $('btnAnalyze').disabled = false;
      
      // Show confirmation
      showMessage('ล้างข้อมูลฟอร์มเรียบร้อยแล้ว', 'success');
    }

    function clearSearch() {
      // Clear search filters
      $('search_rh').value = '';
      $('search_zone').value = '';
      $('search_employee_name').value = '';
      $('search_employee_id').value = '';
      $('search_customer_name').value = '';
      $('search_customer_id').value = '';
      
      // Reset zone select
      $('search_zone').innerHTML = '<option value="">ทั้งหมด</option>';
      
      // Clear results
      $('customerList').innerHTML = `
        <div class="search-placeholder">
          <i class="fas fa-search" style="font-size: 48px; margin-bottom: 16px; color: var(--gray-4);"></i>
          <p>กรุณาใช้ฟิลเตอร์ด้านบนเพื่อค้นหาข้อมูลลูกค้า</p>
          <small style="color: var(--text-secondary);">ระบบจะแสดงข้อมูลเฉพาะเมื่อค้นหาแล้วเท่านั้น</small>
        </div>
      `;
    }

    function showMessage(message, type = 'success') {
      const statusDiv = $('formStatus');
      statusDiv.textContent = message;
      statusDiv.className = 'form-status';
      
      if (type === 'error') {
        statusDiv.style.backgroundColor = 'var(--red)';
      } else if (type === 'success') {
        statusDiv.style.backgroundColor = 'var(--green)';
      }
      
      statusDiv.style.display = 'block';
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 5000);
    }

    function showError(message) {
      alert(`ข้อผิดพลาด: ${message}`);
    }

    // =============================================
    // Initialize Application
    // =============================================

    // Make functions available globally for inline event handlers
    window.removePolicyForm = removePolicyForm;
    window.viewCustomerDetails = viewCustomerDetails;
    window.closeCustomerModal = closeCustomerModal;

    // Close modal when clicking overlay
    $('customerModalOverlay')?.addEventListener('click', closeCustomerModal);
    $('closeCustomerModal')?.addEventListener('click', closeCustomerModal);

    // Initialize the app when DOM is loaded
    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>
